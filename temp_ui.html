
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecoflow Controller</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --primary: #00E676; --danger: #ff5252; --text: #e0e0e0; --sub: #a0a0a0; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; padding-bottom: 100px; overflow-x: hidden; }
        #canvas-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.6; }
        h1, h2, h3 { margin: 0; }
        .container { max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; position: relative; z-index: 1; }
        .card { background: rgba(30, 30, 30, 0.85); backdrop-filter: blur(8px); border-radius: 12px; padding: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: transform 0.2s, box-shadow 0.2s; position: relative; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 12px rgba(0,0,0,0.4); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; cursor: pointer; transition: opacity 0.2s; }
        .header:hover { opacity: 0.8; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #555; margin-right: 8px; display: inline-block; }
        .status-dot.on { background: var(--primary); box-shadow: 0 0 8px var(--primary); }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .stat { background: #2a2a2a; padding: 8px; border-radius: 8px; text-align: center; }
        .stat-label { font-size: 0.8em; color: var(--sub); }
        .stat-val { font-size: 1.1em; font-weight: bold; }

        /* Controls */
        .controls { border-top: 1px solid #333; padding-top: 12px; display: none; }
        .controls.open { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .ctrl-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .btn { border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; color: #fff; transition: opacity 0.2s; }
        .btn:active { opacity: 0.7; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-danger { background: var(--danger); }
        .btn-sub { background: #444; }
        .btn-icon { padding: 8px; font-size: 1.2em; }

        /* Add Device Button */
        #add-device-btn {
            background: linear-gradient(135deg, var(--primary) 0%, #00b359 100%);
            box-shadow: 0 4px 15px rgba(0, 230, 118, 0.3);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9em;
            display: flex; align-items: center; gap: 5px; cursor: pointer;
        }
        #add-device-btn:hover { transform: scale(1.05); }

        /* Add Device Menu */
        #add-device-menu {
            position: absolute; top: 50px; right: 0;
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(12px);
            border: 1px solid #333; border-radius: 12px; padding: 10px;
            display: flex; flex-direction: column; gap: 8px;
            min-width: 180px;
            transform-origin: top right;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0; transform: scale(0.8) translateY(-10px); pointer-events: none;
            z-index: 100;
        }
        #add-device-menu.show { opacity: 1; transform: scale(1) translateY(0); pointer-events: auto; }
        .menu-item { background: #333; padding: 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s; text-align: left;}
        .menu-item:hover { background: #444; }

        /* 3-Dot Menu */
        .card-menu-btn { cursor: pointer; padding: 5px; font-weight: bold; font-size: 1.2em; color: #aaa; }
        .card-menu {
            position: absolute; top: 40px; right: 10px;
            background: #222; border: 1px solid #444; border-radius: 8px;
            padding: 5px; display: none; z-index: 10;
        }
        .card-menu.show { display: block; animation: fadeIn 0.2s; }
        .menu-opt { padding: 8px 12px; cursor: pointer; white-space: nowrap; }
        .menu-opt:hover { background: #333; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Segmented Control (Futuristic Switch) */
        .seg-ctrl { display: flex; background: #111; border-radius: 8px; padding: 4px; gap: 4px; }
        .seg-opt { flex: 1; padding: 8px; text-align: center; cursor: pointer; border-radius: 6px; font-size: 0.9em; transition: all 0.2s; color: #888; display:flex; flex-direction:column; align-items:center; justify-content:center;}
        .seg-opt:hover { background: #222; }
        .seg-opt.active { background: #333; color: var(--primary); font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        /* Power Button for Wave 2 */
        .pwr-btn-large {
            width: 60px; height: 60px; border-radius: 50%;
            background: #222; border: 2px solid #444;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5em; color: #555; cursor: pointer;
            transition: all 0.3s; margin: 0 auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .pwr-btn-large.on {
            border-color: var(--primary); color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 230, 118, 0.4);
        }
        .pwr-btn-large:active { transform: scale(0.95); }

        /* Range */
        input[type=range] { width: 100%; background: transparent; -webkit-appearance: none; margin: 10px 0; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: #444; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { height: 20px; width: 20px; border-radius: 50%; background: var(--primary); -webkit-appearance: none; margin-top: -7px; }

        /* Dial for Wave 2 */
        .dial-container { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 10px 0; }
        .dial-val { font-size: 2em; font-weight: bold; min-width: 60px; text-align: center; }

        /* Console */
        #console { font-family: monospace; background: #000; color: #0f0; padding: 10px; border-radius: 8px; height: 200px; overflow-y: auto; font-size: 0.8em; margin-top: 20px; }
        .log-line { border-bottom: 1px solid #111; padding: 2px 0; word-wrap: break-word; }
        .log-V { color: #888; } .log-D { color: #aaa; } .log-I { color: #fff; } .log-W { color: #ea0; } .log-E { color: #f44; }

        /* Intro */
        .intro { text-align: center; padding: 40px 0; }
        select { padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; font-size: 1em; }

        .hidden { display: none !important; }
        .disabled-ui { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
        canvas.graph { width: 100%; height: 150px; background: #222; border-radius: 8px; margin-top: 10px; }
    </style>

    <script>
    window.fetch = async (url, options) => {
        console.log('Mock Fetch:', url);
        if (url.includes('/api/status')) {
            return {
                json: async () => ({
                    esp_temp: 42.5,
                    d3: { connected: true, sn: 'D3-123', name: 'Delta 3', batt: 85, in: 100, out: 200, solar: 50, cell_temp: 25, ac_on: true, dc_on: false, usb_on: true, ac_out_pow: 150, dc_out_pow: 0, usb_out_pow: 50, cfg_ac_lim: 800, cfg_max: 100, cfg_min: 0 },
                    w2: { connected: true, sn: 'W2-456', name: 'Wave 2', batt: 60, amb_temp: 24, out_temp: 18, set_temp: 20, mode: 0, sub_mode: 2, fan: 1, pwr: true, drain: false, light: true, beep: false, pwr_bat: -100, pwr_mppt: 0, pwr_psdr: 0 },
                    d3p: { connected: false },
                    ac: { connected: false }
                })
            };
        }
        if (url.includes('/api/history')) {
            return { json: async () => [20, 21, 20, 19, 18, 18, 18] };
        }
        if (url.includes('/api/control')) {
            const body = JSON.parse(options.body);
            console.log('Control:', body);
            // For testing, we can't easily update state without a real backend loop,
            // but we can verify the click happened.
            return { ok: true };
        }
        return { ok: true, json: async () => ({}) };
    };
    </script>
    </head>
<body>
    <canvas id="canvas-bg"></canvas>
    <div class="container">
        <!-- Main Header -->
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display:flex; align-items:center; gap:10px">
                <h2>‚ö° Ecoflow CTRL</h2>
                <div id="global-status" class="status-dot"></div>
            </div>
            <div style="display:flex; align-items:center; gap:15px; position: relative;">
                <button id="add-device-btn" onclick="toggleAddMenu()">
                    <span>+ Add</span>
                </button>
                <div id="add-device-menu">
                    <div class="menu-item" onclick="connectDevice('d3')">Delta 3</div>
                    <div class="menu-item" onclick="connectDevice('w2')">Wave 2</div>
                    <div class="menu-item" onclick="connectDevice('d3p')">Delta Pro 3</div>
                    <div class="menu-item" onclick="connectDevice('ac')">Alternator Charger</div>
                </div>
                <span id="esp-temp" style="font-size:0.8em; color:#aaa">--¬∞C</span>
            </div>
        </div>

        <div id="intro-screen" class="intro hidden">
            <h3>No Devices Connected</h3>
            <p style="color:#aaa; margin-bottom: 20px;">Use the "+ Add" button to connect a device.</p>
        </div>

        <div id="device-list"></div>

        <div class="card">
            <div class="header" onclick="toggleLogs()">
                <h3>üìã Logs & Debug</h3>
                <button class="btn btn-sub" id="log-toggle-btn">Show</button>
            </div>
            <div id="log-section" class="hidden">
                <div class="ctrl-row">
                    <label class="switch"><input type="checkbox" id="log-enable" onchange="setLogConfig()"><span class="slider"></span></label>
                    <span>Enable Logs</span>
                    <select id="log-level" onchange="setLogConfig()" style="margin-left: auto;">
                        <option value="5">Verbose</option>
                        <option value="4">Debug</option>
                        <option value="3">Info</option>
                        <option value="2">Warn</option>
                        <option value="1">Error</option>
                    </select>
                </div>
                <div class="ctrl-row">
                    <select id="log-tag" onchange="setLogConfig()" style="width: 100%; padding: 8px; background: #333; border:1px solid #444; color:#fff; border-radius:4px;">
                        <option value="Global">Global (All Tags)</option>
                        <option value="NimBLE">NimBLE</option>
                        <option value="NimBLEScan">NimBLEScan</option>
                        <option value="CmdUtils">CmdUtils</option>
                        <option value="EcoflowCrypto">EcoflowCrypto</option>
                        <option value="EcoflowDataParser">EcoflowDataParser</option>
                        <option value="EcoflowESP32">EcoflowESP32</option>
                        <option value="EcoflowProtocol">EcoflowProtocol</option>
                        <option value="WebServer">WebServer</option>
                        <option value="DeviceManager">DeviceManager</option>
                        <option value="System">System</option>
                        <option value="WiFi">WiFi</option>
                    </select>
                </div>
                <div class="ctrl-row" style="justify-content: flex-end; font-size: 0.8em;">
                     <label><input type="checkbox" id="auto-scroll" checked> Auto-scroll</label>
                </div>
                <div id="console"></div>
                <div class="ctrl-row">
                    <button class="btn btn-sub" onclick="clearLogs()">Clear</button>
                </div>
                <hr style="border-color:#333; margin: 15px 0;">
                <div class="ctrl-row">
                     <input type="text" id="cli-input" placeholder="Send raw command (e.g. sys_temp)..." style="width: 100%; padding: 8px; background: #333; border:1px solid #444; color:#fff; border-radius:4px; margin-right: 10px;" onkeydown="if(event.key==='Enter') sendCli()">
                     <button class="btn btn-primary" onclick="sendCli()">Send</button>
                </div>
            </div>
        </div>
    </div>

<script>
    const API = '/api';
    let knownDevices = new Set();
    let logPollInterval = null;
    let lastLogCount = 0;

    function el(id) { return document.getElementById(id); }

    // --- Templates ---

    // Helper for 3-dot menu
    const renderCardMenu = (type) => `
        <div class="card-menu-btn" onclick="event.stopPropagation(); toggleCardMenu('${type}')">‚ãÆ</div>
        <div id="menu-${type}" class="card-menu">
            <div class="menu-opt" onclick="disconnect('${type}')">Disconnect</div>
        </div>
    `;

    const renderD3 = (d) => `
        <div class="card" id="card-${d.type}">
            <div class="header" onclick="toggleCtrl('${d.type}')">
                <h3><span class="status-dot ${d.connected?'on':''}" id="dot-${d.type}"></span>Delta 3 (${d.sn})</h3>
                <div style="display:flex; align-items:center; gap:10px">
                    <span class="stat-val" id="batt-${d.type}">${d.batt}%</span>
                    ${renderCardMenu(d.type)}
                </div>
            </div>
            <div class="grid grid-3">
                <div class="stat"><div class="stat-label">In</div><div class="stat-val" id="in-${d.type}">${d.in}W</div></div>
                <div class="stat"><div class="stat-label">Out</div><div class="stat-val" id="out-${d.type}">${d.out}W</div></div>
                <div class="stat"><div class="stat-label">Solar</div><div class="stat-val" id="solar-${d.type}">${d.solar}W</div></div>
            </div>
            <div style="text-align:center; margin-bottom:10px; color:#aaa; font-size:0.8em;">Cell Temp: <span id="temp-${d.type}">${d.cell_temp}</span>¬∞C</div>
            <div class="controls" id="ctrl-${d.type}">
                <div class="ctrl-row">
                    <span>AC Output (<span id="ac-pow-${d.type}" style="color:var(--primary)">0</span>W)</span>
                    <label class="switch"><input type="checkbox" id="ac-${d.type}" onchange="cmd('${d.type}', 'set_ac', this.checked)"><span class="slider"></span></label>
                </div>
                <div class="ctrl-row">
                    <span>DC 12V (<span id="dc-pow-${d.type}" style="color:var(--primary)">0</span>W)</span>
                    <label class="switch"><input type="checkbox" id="dc-${d.type}" onchange="cmd('${d.type}', 'set_dc', this.checked)"><span class="slider"></span></label>
                </div>
                <div class="ctrl-row">
                    <span>USB (<span id="usb-pow-${d.type}" style="color:var(--primary)">0</span>W)</span>
                    <label class="switch"><input type="checkbox" id="usb-${d.type}" onchange="cmd('${d.type}', 'set_usb', this.checked)"><span class="slider"></span></label>
                </div>
                <hr style="border-color:#333">
                <div class="ctrl-row">
                    <span>AC Charge Limit: <b id="val-ac-${d.type}">${d.cfg_ac_lim}</b>W</span>
                </div>
                <input type="range" id="rg-ac-${d.type}" min="200" max="2000" step="100" value="${d.cfg_ac_lim}" onchange="cmd('${d.type}', 'set_ac_lim', parseInt(this.value))" oninput="el('val-ac-${d.type}').innerText=this.value">

                <div class="ctrl-row">
                    <span>Max Charge (50-100%): <b id="val-max-${d.type}">${d.cfg_max}</b>%</span>
                </div>
                <input type="range" id="rg-max-${d.type}" min="50" max="100" step="1" value="${d.cfg_max}" onchange="cmd('${d.type}', 'set_max_soc', parseInt(this.value))" oninput="el('val-max-${d.type}').innerText=this.value">

                <div class="ctrl-row">
                    <span>Min Discharge (0-30%): <b id="val-min-${d.type}">${d.cfg_min}</b>%</span>
                </div>
                <input type="range" id="rg-min-${d.type}" min="0" max="30" step="1" value="${d.cfg_min}" onchange="cmd('${d.type}', 'set_min_soc', parseInt(this.value))" oninput="el('val-min-${d.type}').innerText=this.value">

                <div style="margin-top:15px">
                    <span style="font-size:0.8em; color:#aaa">Solar Input (1h)</span>
                    <canvas id="graph-d3" class="graph" width="300" height="150"></canvas>
                </div>
            </div>
        </div>`;

    const renderW2 = (d) => `
        <div class="card" id="card-${d.type}">
            <div class="header" onclick="toggleCtrl('${d.type}')">
                <h3><span class="status-dot ${d.connected?'on':''}" id="dot-${d.type}"></span>Wave 2 (${d.sn})</h3>
                <div style="display:flex; align-items:center; gap:10px">
                    <span class="stat-val" id="batt-${d.type}">${d.batt}%</span>
                     ${renderCardMenu(d.type)}
                </div>
            </div>
            <div class="grid">
                <div class="stat"><div class="stat-label">Amb Temp</div><div class="stat-val"><span id="amb-${d.type}">${d.amb_temp}</span>¬∞C</div></div>
                <div class="stat"><div class="stat-label">Out Temp</div><div class="stat-val"><span id="out-${d.type}">${d.out_temp}</span>¬∞C</div></div>
            </div>
            <div class="controls" id="ctrl-${d.type}">
                <div style="text-align:center; margin-bottom:15px;">
                     <div class="pwr-btn-large" id="pwr-btn-${d.type}" onclick="toggleW2Power()">
                        <div style="font-size:0.5em; position:absolute; margin-top:-35px;">POWER</div>
                        ‚èª
                     </div>
                     <div style="margin-top:5px; font-size:0.8em; color:#888;">
                        Draw: <span id="w2-draw-${d.type}">0</span>W
                     </div>
                </div>

                <div id="w2-ui-body-${d.type}"> <!-- Wraps controls to hide when off -->
                    <div class="ctrl-row" style="justify-content:center">
                        <span style="font-size:0.9em; color:#aaa; margin-right:10px">Set Temp</span>
                    </div>
                    <div class="dial-container">
                        <button class="btn btn-sub btn-icon" onclick="cmd('${d.type}', 'set_temp', parseInt(el('dial-${d.type}').innerText) - 1)">-</button>
                        <div class="dial-val"><span id="dial-${d.type}">${d.set_temp}</span>¬∞C</div>
                        <button class="btn btn-sub btn-icon" onclick="cmd('${d.type}', 'set_temp', parseInt(el('dial-${d.type}').innerText) + 1)">+</button>
                    </div>

                    <div class="ctrl-row">
                        <span>Mode</span>
                        <div class="seg-ctrl">
                            <div class="seg-opt" id="mode-0-${d.type}" onclick="cmd('${d.type}', 'set_mode', 0)">Cool</div>
                            <div class="seg-opt" id="mode-1-${d.type}" onclick="cmd('${d.type}', 'set_mode', 1)">Heat</div>
                            <div class="seg-opt" id="mode-2-${d.type}" onclick="cmd('${d.type}', 'set_mode', 2)">Fan</div>
                        </div>
                    </div>

                    <div class="ctrl-row hidden" id="sub-mode-row-${d.type}">
                        <span>Sub Mode</span>
                        <div class="seg-ctrl">
                            <div class="seg-opt" id="sub-0-${d.type}" onclick="cmd('${d.type}', 'set_sub_mode', 0)"><div>üöÄ</div><small>Max</small></div>
                            <div class="seg-opt" id="sub-3-${d.type}" onclick="cmd('${d.type}', 'set_sub_mode', 3)"><div>‚ö™</div><small>Norm</small></div>
                            <div class="seg-opt" id="sub-2-${d.type}" onclick="cmd('${d.type}', 'set_sub_mode', 2)"><div>üå±</div><small>Eco</small></div>
                            <div class="seg-opt" id="sub-1-${d.type}" onclick="cmd('${d.type}', 'set_sub_mode', 1)"><div>üåô</div><small>Night</small></div>
                        </div>
                    </div>
                    <div class="ctrl-row">
                        <span>Fan Speed</span>
                        <div class="seg-ctrl">
                            <div class="seg-opt" id="fan-0-${d.type}" onclick="cmd('${d.type}', 'set_fan', 0)">Low</div>
                            <div class="seg-opt" id="fan-1-${d.type}" onclick="cmd('${d.type}', 'set_fan', 1)">Med</div>
                            <div class="seg-opt" id="fan-2-${d.type}" onclick="cmd('${d.type}', 'set_fan', 2)">High</div>
                        </div>
                    </div>

                    <div class="ctrl-row">
                        <span>Light</span>
                        <label class="switch"><input type="checkbox" id="light-${d.type}" onchange="cmd('${d.type}', 'set_light', this.checked)"><span class="slider"></span></label>
                    </div>
                    <div class="ctrl-row">
                        <span>Beep</span>
                        <label class="switch"><input type="checkbox" id="beep-${d.type}" onchange="cmd('${d.type}', 'set_beep', this.checked)"><span class="slider"></span></label>
                    </div>
                    <div class="ctrl-row">
                        <span>Auto Drain</span>
                        <label class="switch"><input type="checkbox" id="drain-${d.type}" onchange="cmd('${d.type}', 'set_drain', this.checked)"><span class="slider"></span></label>
                    </div>

                    <div style="margin-top:15px">
                        <span style="font-size:0.8em; color:#aaa">Temp History (1h)</span>
                        <canvas id="graph-w2" class="graph" width="300" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>`;

    const renderD3P = (d) => `
        <div class="card" id="card-${d.type}">
            <div class="header" onclick="toggleCtrl('${d.type}')">
                <h3><span class="status-dot ${d.connected?'on':''}" id="dot-${d.type}"></span>Delta Pro 3 (${d.sn})</h3>
                <div style="display:flex; align-items:center; gap:10px">
                    <span class="stat-val" id="batt-${d.type}">${d.batt}%</span>
                    ${renderCardMenu(d.type)}
                </div>
            </div>
            <div class="grid grid-3">
                <div class="stat"><div class="stat-label">In</div><div class="stat-val" id="in-${d.type}">${d.in}W</div></div>
                <div class="stat"><div class="stat-label">Out</div><div class="stat-val" id="out-${d.type}">${d.out}W</div></div>
                <div class="stat"><div class="stat-label">Solar</div><div class="stat-val" id="solar-${d.type}">${d.solar}W</div></div>
            </div>
            <div style="text-align:center; margin-bottom:10px; color:#aaa; font-size:0.8em;">Cell Temp: <span id="temp-${d.type}">${d.cell_temp}</span>¬∞C</div>
            <div class="controls" id="ctrl-${d.type}">
                <div class="ctrl-row">
                    <span>AC Low Volt</span>
                    <label class="switch"><input type="checkbox" id="ac-lv-${d.type}" onchange="cmd('${d.type}', 'set_ac_lv', this.checked)"><span class="slider"></span></label>
                </div>
                <div class="ctrl-row">
                    <span>AC High Volt</span>
                    <label class="switch"><input type="checkbox" id="ac-hv-${d.type}" onchange="cmd('${d.type}', 'set_ac_hv', this.checked)"><span class="slider"></span></label>
                </div>
                <div class="ctrl-row">
                    <span>DC (12V)</span>
                    <label class="switch"><input type="checkbox" id="dc-${d.type}" onchange="cmd('${d.type}', 'set_dc', this.checked)"><span class="slider"></span></label>
                </div>

                <hr style="border-color:#333">
                <div class="ctrl-row">
                    <span>Max Charge (50-100%): <b id="val-max-${d.type}">${d.cfg_max}</b>%</span>
                </div>
                <input type="range" id="rg-max-${d.type}" min="50" max="100" step="1" value="${d.cfg_max}" onchange="cmd('${d.type}', 'set_max_soc', parseInt(this.value))" oninput="el('val-max-${d.type}').innerText=this.value">

                <div class="ctrl-row">
                    <span>Min Discharge (0-30%): <b id="val-min-${d.type}">${d.cfg_min}</b>%</span>
                </div>
                <input type="range" id="rg-min-${d.type}" min="0" max="30" step="1" value="${d.cfg_min}" onchange="cmd('${d.type}', 'set_min_soc', parseInt(this.value))" oninput="el('val-min-${d.type}').innerText=this.value">

                <div class="ctrl-row">
                    <span>Energy Backup</span>
                    <label class="switch"><input type="checkbox" id="bkp-en-${d.type}" onchange="cmd('${d.type}', 'set_backup_en', this.checked)"><span class="slider"></span></label>
                </div>
                <div class="ctrl-row">
                    <span>Backup Level: <b id="val-bkp-${d.type}">${d.backup_lvl}</b>%</span>
                </div>
                <input type="range" id="rg-bkp-${d.type}" min="0" max="100" value="${d.backup_lvl}" onchange="cmd('${d.type}', 'set_backup_level', parseInt(this.value))" oninput="el('val-bkp-${d.type}').innerText=this.value">

                <div style="margin-top:15px">
                    <span style="font-size:0.8em; color:#aaa">Solar Input (1h)</span>
                    <canvas id="graph-d3p" class="graph" width="300" height="150"></canvas>
                </div>
            </div>
        </div>`;

    const renderAC = (d) => `
        <div class="card" id="card-${d.type}">
            <div class="header" onclick="toggleCtrl('${d.type}')">
                <h3><span class="status-dot ${d.connected?'on':''}" id="dot-${d.type}"></span>Alt Charger (${d.sn})</h3>
                <div style="display:flex; align-items:center; gap:10px">
                    <span class="stat-val" id="batt-${d.type}">${d.batt}%</span>
                    ${renderCardMenu(d.type)}
                </div>
            </div>
            <div class="grid">
                <div class="stat"><div class="stat-label">Car Batt</div><div class="stat-val"><span id="car-${d.type}">${d.car_volt.toFixed(1)}</span>V</div></div>
                <div class="stat"><div class="stat-label">Limit</div><div class="stat-val"><span id="lim-${d.type}">${d.pow_lim}</span>W</div></div>
            </div>
            <div class="controls" id="ctrl-${d.type}">
                <div class="ctrl-row">
                    <span>Charger Enabled</span>
                    <label class="switch"><input type="checkbox" id="chg-${d.type}" onchange="cmd('${d.type}', 'set_open', this.checked)"><span class="slider"></span></label>
                </div>
                <div class="ctrl-row">
                    <span>Mode</span>
                    <select id="mode-${d.type}" onchange="cmd('${d.type}', 'set_mode', parseInt(this.value))" style="width:120px">
                        <option value="0">Idle</option>
                        <option value="1">Charge</option>
                        <option value="2">Maintenance</option>
                        <option value="3">Reverse</option>
                    </select>
                </div>
                <div class="ctrl-row">
                    <span>Power Limit: <b id="val-ac-lim">${d.pow_lim}</b>W</span>
                </div>
                <input type="range" id="rg-lim-${d.type}" min="100" max="800" step="50" value="${d.pow_lim}" onchange="cmd('${d.type}', 'set_limit', parseInt(this.value))" oninput="el('val-ac-lim').innerText=this.value">
            </div>
        </div>`;

    // --- Core Logic ---

    function update() {
        fetch(API + '/status').then(r => r.json()).then(data => {
            if(data.esp_temp) el('esp-temp').innerText = data.esp_temp.toFixed(1) + '¬∞C';

            let anyConnected = false;
            const types = ['d3', 'w2', 'd3p', 'ac'];

            types.forEach(type => {
                const d = data[type];
                if (d && d.connected) {
                    d.type = type;
                    anyConnected = true;

                    // If new device, render card
                    if (!knownDevices.has(type)) {
                        const list = el('device-list');
                        const div = document.createElement('div');
                        if (type === 'd3') div.innerHTML = renderD3(d);
                        else if (type === 'w2') div.innerHTML = renderW2(d);
                        else if (type === 'd3p') div.innerHTML = renderD3P(d);
                        else if (type === 'ac') div.innerHTML = renderAC(d);
                        list.appendChild(div);
                        knownDevices.add(type);

                        // Load initial graph if applicable
                        if (type === 'w2' || type === 'd3' || type === 'd3p') setTimeout(() => loadGraph(type), 500);

                        // Open ctrl panel by default for first device
                        setTimeout(() => el('ctrl-'+type).classList.add('open'), 100);
                    }

                    // Update values (Non-Destructive)
                    updateDeviceUI(type, d);
                } else {
                     // If device disconnected, remove card
                     if (knownDevices.has(type)) {
                         const card = el('card-' + type);
                         if (card) card.parentElement.removeChild(card);
                         knownDevices.delete(type);
                     }
                }
            });

            if (anyConnected) el('intro-screen').classList.add('hidden');
            else el('intro-screen').classList.remove('hidden');

            el('global-status').classList.toggle('on', anyConnected);
        });
    }

    function updateDeviceUI(type, d) {
        // Common
        setTxt('batt-'+type, d.batt + '%');
        setCls('dot-'+type, 'on', d.connected);

        if (type === 'd3') {
            setTxt('in-'+type, d.in + 'W');
            setTxt('out-'+type, d.out + 'W');
            setTxt('solar-'+type, d.solar + 'W');
            setTxt('temp-'+type, d.cell_temp);

            // Power splits
            setTxt('ac-pow-'+type, d.ac_out_pow);
            setTxt('dc-pow-'+type, d.dc_out_pow);
            setTxt('usb-pow-'+type, d.usb_out_pow);

            setCheck('ac-'+type, d.ac_on);
            setCheck('dc-'+type, d.dc_on);
            setCheck('usb-'+type, d.usb_on);

            setVal('rg-ac-'+type, d.cfg_ac_lim); setTxt('val-ac-'+type, d.cfg_ac_lim);
            setVal('rg-max-'+type, d.cfg_max); setTxt('val-max-'+type, d.cfg_max);
            setVal('rg-min-'+type, d.cfg_min); setTxt('val-min-'+type, d.cfg_min);
        }
        else if (type === 'w2') {
            setTxt('amb-'+type, d.amb_temp);
            setTxt('out-'+type, d.out_temp);
            setTxt('dial-'+type, d.set_temp);

            setCheck('light-'+type, d.light);
            setCheck('beep-'+type, d.beep);
            setCheck('drain-'+type, d.drain);

            // Power logic
            const pwrBtn = el('pwr-btn-'+type);
            const uiBody = el('w2-ui-body-'+type);
            if (d.pwr) {
                pwrBtn.classList.add('on');
                uiBody.classList.remove('disabled-ui');
            } else {
                pwrBtn.classList.remove('on');
                uiBody.classList.add('disabled-ui');
            }

            // Power Draw Display priority
            let draw = 0;
            if (d.pwr_mppt > 0) draw = "Solar " + d.pwr_mppt;
            else if (d.pwr_psdr > 0) draw = "DC " + d.pwr_psdr;
            else draw = Math.abs(d.pwr_bat); // Default to bat power (load)
            setTxt('w2-draw-'+type, draw);

            // Segments
            setSeg('mode', type, d.mode, 3);
            setSeg('fan', type, d.fan, 3);

            // Sub-mode visibility
            const subRow = el('sub-mode-row-'+type);
            if (d.mode === 0 || d.mode === 1) { // Cool or Heat
                subRow.classList.remove('hidden');
                setSeg('sub', type, d.sub_mode, 4);
            } else {
                subRow.classList.add('hidden');
            }
        }
        else if (type === 'd3p') {
            setTxt('in-'+type, d.in + 'W');
            setTxt('out-'+type, d.out + 'W');
            setTxt('solar-'+type, d.solar + 'W');
            setTxt('temp-'+type, d.cell_temp);

            setCheck('ac-lv-'+type, d.ac_lv_on);
            setCheck('ac-hv-'+type, d.ac_hv_on);
            setCheck('dc-'+type, d.dc_on);
            setCheck('bkp-en-'+type, d.backup_en);

            setVal('rg-max-'+type, d.cfg_max); setTxt('val-max-'+type, d.cfg_max);
            setVal('rg-min-'+type, d.cfg_min); setTxt('val-min-'+type, d.cfg_min);
            setVal('rg-bkp-'+type, d.backup_lvl); setTxt('val-bkp-'+type, d.backup_lvl);
        }
        else if (type === 'ac') {
             setTxt('car-'+type, d.car_volt.toFixed(1));
             setTxt('lim-'+type, d.pow_lim);
             setCheck('chg-'+type, d.chg_open);
             setVal('mode-'+type, d.mode);
             setVal('rg-lim-'+type, d.pow_lim); setTxt('val-ac-lim', d.pow_lim);
        }
    }

    // --- UI Helpers ---
    function setTxt(id, val) { const e = el(id); if(e && e.innerText != val) e.innerText = val; }
    function setVal(id, val) { const e = el(id); if(e && e.value != val && document.activeElement !== e) e.value = val; }
    function setCheck(id, val) { const e = el(id); if(e && e.checked != val) e.checked = val; }
    function setCls(id, cls, on) { const e = el(id); if(e) { if(on) e.classList.add(cls); else e.classList.remove(cls); } }

    function setSeg(prefix, type, val, count) {
        // val is int. count is num options.
        // Option IDs are prefix-0-type, prefix-1-type...
        // Some modes like sub_mode map: 0->Max, 1->Night, 2->Eco, 3->Norm
        // Check HTML ID correctness.
        // e.g. mode-0-w2, mode-1-w2...
        const all = document.querySelectorAll(`[id^="${prefix}-"][id$="-${type}"]`);
        all.forEach(e => e.classList.remove('active'));
        const active = el(`${prefix}-${val}-${type}`);
        if(active) active.classList.add('active');
    }

    function toggleAddMenu() {
        el('add-device-menu').classList.toggle('show');
    }

    // Close add menu when clicking outside
    document.addEventListener('click', function(e) {
        const menu = el('add-device-menu');
        const btn = el('add-device-btn');
        if (!menu.contains(e.target) && !btn.contains(e.target)) {
            menu.classList.remove('show');
        }

        // Also close card menus
        const cardMenus = document.querySelectorAll('.card-menu');
        cardMenus.forEach(m => {
            // Check if click is on the 3-dot button for this menu
            // We can't easily reference the button from here without ID, but we can verify target
            if (!m.contains(e.target) && !e.target.classList.contains('card-menu-btn')) {
                m.classList.remove('show');
            }
        });
    });

    function toggleCardMenu(type) {
        const menu = el('menu-'+type);
        // Close others
        document.querySelectorAll('.card-menu').forEach(m => { if(m!==menu) m.classList.remove('show'); });
        menu.classList.toggle('show');
    }

    function toggleW2Power() {
        // Toggle power based on current class state (not ideal but quick)
        // Better to use state from last fetch.
        // But for responsiveness, toggle visually? No, wait for server.
        const pwr = el('pwr-btn-w2').classList.contains('on');
        cmd('w2', 'set_power', !pwr); // This just sends true/false, handled by backend to 1/2
    }

    function toggleCtrl(id) {
        const e = el('ctrl-'+id);
        e.classList.toggle('open');
        if((id === 'w2' || id === 'd3' || id === 'd3p') && e.classList.contains('open')) loadGraph(id);
    }

    function loadGraph(type) {
        const canvas = el('graph-' + type);
        if(!canvas) return;
        fetch(API + '/history?type=' + type).then(r => r.json()).then(data => {
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0,0,w,h);

            if(!data || data.length === 0) {
                ctx.fillStyle = '#555';
                ctx.fillText('No Data', w/2-20, h/2);
                return;
            }

            ctx.strokeStyle = '#00E676';
            ctx.lineWidth = 2;
            ctx.beginPath();

            const min = Math.min(...data) - 2;
            const max = Math.max(...data) + 2;
            const range = max - min || 1;

            data.forEach((val, i) => {
                const x = (i / (data.length - 1)) * w;
                const y = h - ((val - min) / range) * h;
                if(i===0) ctx.moveTo(x,y);
                else ctx.lineTo(x,y);
            });
            ctx.stroke();

            // Current value dot
            const lastY = h - ((data[data.length-1] - min) / range) * h;
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(w-4, lastY, 3, 0, Math.PI*2);
            ctx.fill();
        });
    }

    function connectDevice(type) {
        el('add-device-menu').classList.remove('show');
        if (!type) type = el('dev-select').value;
        fetch(API + '/connect', { method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type}) })
        .then(()=> {
            // alert('Scanning started...'); // Removed alert for smoother UX
        });
    }

    function disconnect(type) {
        if(!confirm('Disconnect device?')) return;
        fetch(API + '/disconnect', { method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type}) });
    }

    function cmd(type, cmdName, val) {
        fetch(API + '/control', {
            method: 'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({type, cmd: cmdName, val: val})
        });
    }

    // --- Logs ---
    function toggleLogs() {
        el('log-section').classList.toggle('hidden');
        if (!el('log-section').classList.contains('hidden')) {
            startLogPoll();
        } else {
            stopLogPoll();
        }
    }

    function startLogPoll() {
        if (logPollInterval) return;
        lastLogCount = 0;
        el('console').innerHTML = '';

        logPollInterval = setInterval(() => {
            fetch(API + '/logs?index=' + lastLogCount).then(r => r.json()).then(logs => {
                const c = el('console');

                logs.forEach(l => {
                    const d = new Date(l.ts);
                    const time = d.getHours()+':'+d.getMinutes()+':'+d.getSeconds();
                    const line = document.createElement('div');
                    line.className = 'log-line log-' + (['?','E','W','I','D','V'][l.lvl] || 'I');
                    line.innerText = `[${time}] ${l.tag}: ${l.msg}`;
                    c.appendChild(line);
                });

                lastLogCount += logs.length;

                if(logs.length > 0 && el('auto-scroll').checked) {
                    c.scrollTop = c.scrollHeight;
                }
            });
        }, 1000);
    }

    function stopLogPoll() {
        clearInterval(logPollInterval);
        logPollInterval = null;
    }

    function setLogConfig() {
        const enabled = el('log-enable').checked;
        const level = parseInt(el('log-level').value);
        const tag = el('log-tag').value;

        fetch(API + '/log_config', {
             method: 'POST',
             headers:{'Content-Type':'application/json'},
             body:JSON.stringify({enable: enabled, level, tag})
        });
    }

    function clearLogs() {
        el('console').innerHTML = '';
    }

    function sendCli() {
        const cmd = el('cli-input').value;
        if(!cmd) return;
        fetch(API + '/raw_command', {
            method: 'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({cmd})
        }).then(r => {
            if(r.ok) {
                el('cli-input').value = '';
                const c = el('console');
                const line = document.createElement('div');
                line.className = 'log-line log-I';
                line.innerText = `> ${cmd}`;
                c.appendChild(line);
                if (el('auto-scroll').checked) c.scrollTop = c.scrollHeight;
            } else {
                alert('Command failed');
            }
        });
    }

    setInterval(update, 1000);
    update(); // Initial call

    // --- Particle Background ---
    const canvas = document.getElementById('canvas-bg');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let w, h;

    function resize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
        initParticles();
    }

    function initParticles() {
        particles = [];
        const cnt = Math.floor(w * h / 15000); // density
        for(let i=0; i<cnt; i++) {
            particles.push({
                x: Math.random()*w, y: Math.random()*h,
                vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5
            });
        }
    }

    function draw() {
        ctx.clearRect(0,0,w,h);
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.strokeStyle = 'rgba(255,255,255,0.05)';

        for(let i=0; i<particles.length; i++) {
            let p = particles[i];
            p.x += p.vx; p.y += p.vy;
            if(p.x < 0 || p.x > w) p.vx *= -1;
            if(p.y < 0 || p.y > h) p.vy *= -1;

            ctx.beginPath();
            ctx.arc(p.x, p.y, 1.5, 0, Math.PI*2);
            ctx.fill();

            for(let j=i+1; j<particles.length; j++) {
                let p2 = particles[j];
                let dx = p.x - p2.x, dy = p.y - p2.y;
                let dist = dx*dx + dy*dy;
                if(dist < 15000) {
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                }
            }
        }
        requestAnimationFrame(draw);
    }

    window.addEventListener('resize', resize);
    resize();
    draw();
</script>
</body>
</html>
